#!/bin/bash

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║              🧹 ПОЛНАЯ ОЧИСТКА DOCKER                           ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""
echo "⚠️  ВНИМАНИЕ: Это удалит ВСЁ в Docker:"
echo "   - Все контейнеры (работающие и остановленные)"
echo "   - Все образы"
echo "   - Все volumes (включая данные БД!)"
echo "   - Все сети"
echo "   - Весь build cache"
echo ""
read -p "Продолжить? (yes/no): " -r
echo ""

if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "Отменено"
    exit 0
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🛑 Шаг 1: Остановка всех контейнеров"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose down -v
docker stop $(docker ps -aq) 2>/dev/null
echo "✅ Контейнеры остановлены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🗑️  Шаг 2: Удаление всех контейнеров"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker rm -f $(docker ps -aq) 2>/dev/null
echo "✅ Контейнеры удалены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🖼️  Шаг 3: Удаление всех образов"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker rmi -f $(docker images -aq) 2>/dev/null
echo "✅ Образы удалены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "💾 Шаг 4: Удаление всех volumes"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker volume rm $(docker volume ls -q) 2>/dev/null
echo "✅ Volumes удалены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🌐 Шаг 5: Удаление всех сетей"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker network prune -f
echo "✅ Сети удалены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🗑️  Шаг 6: System prune (всё остальное + build cache)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker system prune -a -f --volumes
echo "✅ System prune завершён"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 Шаг 7: Проверка освобождённого места"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker system df
echo ""

echo "════════════════════════════════════════════════════════════════════"
echo "✅ ОЧИСТКА ЗАВЕРШЕНА!"
echo "════════════════════════════════════════════════════════════════════"
echo ""
echo "Docker полностью очищен. Теперь можно запустить rebuild:"
echo "   ./docker_rebuild.sh"
echo ""
