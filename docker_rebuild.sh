#!/bin/bash

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║         🔨 ПОЛНАЯ ПЕРЕСБОРКА И ЗАПУСК                          ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🛑 Шаг 1: Остановка существующих контейнеров"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose down -v
echo "✅ Контейнеры остановлены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔨 Шаг 2: Сборка образов (без кэша)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose build --no-cache --pull
echo "✅ Образы собраны"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🚀 Шаг 3: Запуск с force-recreate"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose up -d --force-recreate --remove-orphans
echo "✅ Контейнеры запущены"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "⏳ Шаг 4: Ожидание готовности сервисов (30 сек)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
sleep 30
echo "✅ Сервисы должны быть готовы"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 Шаг 5: Статус контейнеров"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
docker-compose ps
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔍 Шаг 6: Проверка здоровья сервисов"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "PostgreSQL:"
docker-compose exec -T postgres pg_isready 2>/dev/null && echo "✅ Ready" || echo "❌ Not ready"
echo ""
echo "API Health:"
curl -s http://localhost:8000/health 2>/dev/null && echo "✅ Ready" || echo "❌ Not ready"
echo ""

echo "════════════════════════════════════════════════════════════════════"
echo "✅ REBUILD ЗАВЕРШЁН!"
echo "════════════════════════════════════════════════════════════════════"
echo ""
echo "🌐 Доступные сервисы:"
echo "   API:      http://localhost:8000"
echo "   Docs:     http://localhost:8000/docs"
echo "   Editor:   http://localhost:8000/editor"
echo "   Directus: http://localhost:8055"
echo "   Qdrant:   http://localhost:6333"
echo ""
echo "📋 Следующие шаги:"
echo "   1. Установить модели: ./install_models.sh"
echo "   2. Запустить парсинг: docker-compose exec api python run_full_pipeline.py 10"
echo ""
